!function(a,b){"object"==typeof exports&&exports?module.exports=b:"function"==typeof define&&define.amd?define(b):a.Mustache=b}(this,function(){function a(a,b){return s.call(a,b)}function b(b){return!a(o,b)}function c(a){return a.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g,"\\$&")}function d(a){return String(a).replace(/[&<>"'\/]/g,function(a){return v[a]})}function e(a){this.string=a,this.tail=a,this.pos=0}function f(a,b){this.view=a,this.parent=b,this._cache={}}function g(){this.clearCache()}function h(a,b,c,d){for(var e,f,g,i="",j=0,k=a.length;k>j;++j)switch(e=a[j],f=e[1],e[0]){case"#":if(g=c.lookup(f),"object"==typeof g)if(u(g))for(var m=0,n=g.length;n>m;++m)i+=h(e[4],b,c.push(g[m]),d);else g&&(i+=h(e[4],b,c.push(g),d));else if("function"==typeof g){var o=null==d?null:d.slice(e[3],e[5]);g=g.call(c.view,o,function(a){return b.render(a,c)}),null!=g&&(i+=g)}else g&&(i+=h(e[4],b,c,d));break;case"^":g=c.lookup(f),(!g||u(g)&&0===g.length)&&(i+=h(e[4],b,c,d));break;case">":g=b.getPartial(f),"function"==typeof g&&(i+=g(c));break;case"&":g=c.lookup(f),null!=g&&(i+=g);break;case"name":g=c.lookup(f),null!=g&&(i+=l.escape(g));break;case"text":i+=f}return i}function i(a){for(var b,c=[],d=c,e=[],f=0,g=a.length;g>f;++f)switch(b=a[f],b[0]){case"#":case"^":e.push(b),d.push(b),d=b[4]=[];break;case"/":var h=e.pop();h[5]=b[2],d=e.length>0?e[e.length-1][4]:c;break;default:d.push(b)}return c}function j(a){for(var b,c,d=[],e=0,f=a.length;f>e;++e)b=a[e],b&&("text"===b[0]&&c&&"text"===c[0]?(c[1]+=b[1],c[3]=b[3]):(c=b,d.push(b)));return d}function k(a){return[new RegExp(c(a[0])+"\\s*"),new RegExp("\\s*"+c(a[1]))]}var l={};l.name="mustache.js",l.version="0.7.2",l.tags=["{{","}}"],l.Scanner=e,l.Context=f,l.Writer=g;var m=/\s*/,n=/\s+/,o=/\S/,p=/\s*=/,q=/\s*\}/,r=/#|\^|\/|>|\{|&|=|!/,s=RegExp.prototype.test,t=Object.prototype.toString,u=Array.isArray||function(a){return"[object Array]"===t.call(a)},v={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;"};l.escape=d,e.prototype.eos=function(){return""===this.tail},e.prototype.scan=function(a){var b=this.tail.match(a);return b&&0===b.index?(this.tail=this.tail.substring(b[0].length),this.pos+=b[0].length,b[0]):""},e.prototype.scanUntil=function(a){var b,c=this.tail.search(a);switch(c){case-1:b=this.tail,this.pos+=this.tail.length,this.tail="";break;case 0:b="";break;default:b=this.tail.substring(0,c),this.tail=this.tail.substring(c),this.pos+=c}return b},f.make=function(a){return a instanceof f?a:new f(a)},f.prototype.push=function(a){return new f(a,this)},f.prototype.lookup=function(a){var b=this._cache[a];if(!b){if("."==a)b=this.view;else for(var c=this;c;){if(a.indexOf(".")>0){b=c.view;for(var d=a.split("."),e=0;b&&e<d.length;)b=b[d[e++]]}else b=c.view[a];if(null!=b)break;c=c.parent}this._cache[a]=b}return"function"==typeof b&&(b=b.call(this.view)),b},g.prototype.clearCache=function(){this._cache={},this._partialCache={}},g.prototype.compile=function(a,b){var c=this._cache[a];if(!c){var d=l.parse(a,b);c=this._cache[a]=this.compileTokens(d,a)}return c},g.prototype.compilePartial=function(a,b,c){var d=this.compile(b,c);return this._partialCache[a]=d,d},g.prototype.getPartial=function(a){return a in this._partialCache||!this._loadPartial||this.compilePartial(a,this._loadPartial(a)),this._partialCache[a]},g.prototype.compileTokens=function(a,b){var c=this;return function(d,e){if(e)if("function"==typeof e)c._loadPartial=e;else for(var g in e)c.compilePartial(g,e[g]);return h(a,c,f.make(d),b)}},g.prototype.render=function(a,b,c){return this.compile(a)(b,c)},l.parse=function(a,d){function f(){if(z&&!A)for(;y.length;)delete x[y.pop()];else y=[];z=!1,A=!1}if(a=a||"",d=d||l.tags,"string"==typeof d&&(d=d.split(n)),2!==d.length)throw new Error("Invalid tags: "+d.join(", "));for(var g,h,o,s,t,u=k(d),v=new e(a),w=[],x=[],y=[],z=!1,A=!1;!v.eos();){if(g=v.pos,o=v.scanUntil(u[0]))for(var B=0,C=o.length;C>B;++B)s=o.charAt(B),b(s)?y.push(x.length):A=!0,x.push(["text",s,g,g+1]),g+=1,"\n"==s&&f();if(!v.scan(u[0]))break;if(z=!0,h=v.scan(r)||"name",v.scan(m),"="===h?(o=v.scanUntil(p),v.scan(p),v.scanUntil(u[1])):"{"===h?(o=v.scanUntil(new RegExp("\\s*"+c("}"+d[1]))),v.scan(q),v.scanUntil(u[1]),h="&"):o=v.scanUntil(u[1]),!v.scan(u[1]))throw new Error("Unclosed tag at "+v.pos);if(t=[h,o,g,v.pos],x.push(t),"#"===h||"^"===h)w.push(t);else if("/"===h){if(0===w.length)throw new Error('Unopened section "'+o+'" at '+g);var D=w.pop();if(D[1]!==o)throw new Error('Unclosed section "'+D[1]+'" at '+g)}else if("name"===h||"{"===h||"&"===h)A=!0;else if("="===h){if(d=o.split(n),2!==d.length)throw new Error("Invalid tags at "+g+": "+d.join(", "));u=k(d)}}var D=w.pop();if(D)throw new Error('Unclosed section "'+D[1]+'" at '+v.pos);return x=j(x),i(x)};var w=new g;return l.clearCache=function(){return w.clearCache()},l.compile=function(a,b){return w.compile(a,b)},l.compilePartial=function(a,b,c){return w.compilePartial(a,b,c)},l.compileTokens=function(a,b){return w.compileTokens(a,b)},l.render=function(a,b,c){return w.render(a,b,c)},l.to_html=function(a,b,c,d){var e=l.render(a,b,c);return"function"!=typeof d?e:(d(e),void 0)},l}()),window.EMBARRASSING_BODIES=function(a,b){"use_strict";return a.CLINIC_FINDER=function(a,b,c){return b.MODEL=function(a,b,c,d){var e=/([A-Z]{1,2}[0-9]{1,2}[A-Z]?)/,f=/([A-Z]{1,2}[0-9]{1,2}[A-Z]?)\s?([0-9]{1,2}[A-Z]{1,2})/,g={text:"",result:[]},h=function(a,b){g.text=a,g.result=b,b.length&&c.getClinic(b[0].id,!1)};c.getResult=function(){return d.extend(!0,{},g)};var i={latitude:null,longitude:null},j={latitude:null,longitude:null};c.location_timeout=!1;var k=function(a){c.location_timeout=!1,m(a.coords),j=d.extend(!0,{},i),b.VIEW.locationUpdate(),b.VIEW.validForm(!d("input.invalid").length||b.MODEL.getLocation())},l=function(){c.clearLocation(),b.VIEW.locationError(),b.VIEW.validForm(!d("input.invalid").length||b.MODEL.getLocation())};c.findLocation=function(){if(!c.getLocation()){if(null===j.latitude||null===j.longitude)return navigator.geolocation.getCurrentPosition(k,l),void 0;i=d.extend(!0,{},j)}b.VIEW.locationUpdate(),b.VIEW.validForm(!d("input.invalid").length||b.MODEL.getLocation())};var m=function(a){var b=parseFloat(a.latitude);isNaN(b)||(i.latitude=b);var c=parseFloat(a.longitude);isNaN(c)||(i.longitude=c)};c.getLocation=function(){return null!==i.latitude&&null!==i.longitude?d.extend(!0,{},i):!1},c.clearLocation=function(){i={latitude:null,longitude:null},b.VIEW.locationUpdate(),b.VIEW.validForm(b.CONTROLLER.validateForm())};var n={},o=function(a,b){n[a]=b};c._isPostCode=function(a){var b=a.toUpperCase(),c=b.match(f);return null!==c?c[1]+c[2]:(c=b.match(e),null!==c?c[1]:!1)};var p=function(a,c){var d={};d.search_text=a,d.results=c,b.VIEW.renderPlaces(a,c)},q=function(a,c){c.length?(h(a,c),window.location.hash="results"):b.VIEW.renderPlaces(a,c)};return c.getPlaceResults=function(a,c){b.VIEW.showLoading(),d.ajax("/nhs/",{data:{place:c},dataType:"json",success:function(b){h(a,b),window.location.hash="results"},error:function(){b.VIEW.renderError()},complete:function(){b.VIEW.hideLoading()}})},c.getClinic=function(a,c){"undefined"==typeof c&&(c=!0),n.hasOwnProperty(a)?c&&b.VIEW.renderClinic(n[a]):(c&&b.VIEW.showLoading(),d.ajax("/nhs/",{data:{clinic:a},dataType:"json",success:function(d){o(a,d),c&&b.VIEW.renderClinic(n[a])},error:function(){b.VIEW.renderError()},complete:function(){b.VIEW.hideLoading()}}))},c.search=function(a){var e={search:a},f=p,g=c._isPostCode(a);g&&(e={postcode:g},f=q),b.VIEW.showLoading(),d.ajax("/nhs/",{data:e,dataType:"json",success:function(b){f.call(null,a,b)},error:function(){b.VIEW.renderError()},complete:function(){b.VIEW.hideLoading()}})},c.searchLocation=function(){var a={lat:i.latitude,"long":i.longitude};b.VIEW.showLoading(),d.ajax("/nhs/",{data:a,dataType:"json",success:function(a){q("your location",a)},error:function(){b.VIEW.renderError()},complete:function(){b.VIEW.hideLoading()}})},c}(a,b,b.MODEL||{},c),b}(a,a.CLINIC_FINDER||{},b),a}(window.EMBARRASSING_BODIES||{},window.jQuery),window.EMBARRASSING_BODIES=function(a,b){"use_strict";return a.CLINIC_FINDER=function(a,b,c){return b.VIEW=function(a,b,c,d){var e,f="",g={search:Mustache.compile('{{ &title }}<form><div class="location-found"><label for="search-term" class="hide">Enter Postcode or town</label><input data-error="Please enter a search term" id="search-term" name="search-term" class="validate input" type="text" placeholder="Enter postcode or town"/></div>{{ &geolocation }}<ul class="buttons"><li><input type="submit" value="Search" class="btn search disabled"/></li></ul></form><div class="search-results"><div id="search-results"></div></div>'),places:Mustache.compile('<h2>Places matching "{{ search_text }}"</h2><ol class="places results medium-text">{{ &list }}</ol>'),places_none:Mustache.compile("<h2>No places matched your search, please try again</h2>"),places_result:Mustache.compile('<li><a href="#" data-url="{{ url }}" class="place-result">{{ text }}</a></li>'),results:Mustache.compile('<h1>Results for <span class="highlight">STI testing and treatment</span> near <span class="highlight">{{ text }}</span></h1><ol class="results medium-text">{{ &list }}</ol>'),results_result:Mustache.compile('<li><a href="#" data-id="{{ id }}" class="results-result">{{ name }}</a> <span class="result-distance">{{ distance }} miles away<span></li>'),clinic:Mustache.compile('<h1>{{ name }}</h1><div class="map"><div id="osmap"></div></div><div class="information"><dl><dt>Address</dt><dd><ol class="address">{{ &address }}</ol></dd><dt>Telephone</dt><dd>{{ telephone }}</dd><dt>GP Referral Required</dt><dd>{{ gp_referral }}</dd></dl><div class="non-core">{{ &non_core }}</div></div><p><a href="{{ original }}" rel="external">View on the NHS choices website</a></p>'),error:Mustache.compile("<h1>Sorry, there has been a problem with the search.</h1><p>Please try a different search or come back again later.</p>"),search_again:Mustache.compile('<ul class="buttons"><li><button class="btn restart">Search again</button></li></ul>'),field_error:Mustache.compile('<div class="error-message">{{ error }}</div>'),geolocation:Mustache.compile('<div class="geolocation"><h2 class="location-found x-large-text">or</h2><p>This works on most devices, mobile and desktop, depending on how settings are configured.</p><p><a href="#" class="btn btn-nav geolocate find">{{ button }}</a></p><h2 class="location-found x-large-text">then</h2></div>'),geolocation_find:Mustache.compile("Find your current location"),geolocation_found:Mustache.compile("Using your current location"),geolocation_fail:Mustache.compile("Unable to get your location"),geolocation_thinking:Mustache.compile('Finding your location<span class="thinking"></span>'),geolocation_clear:Mustache.compile('<button class="clear-location">Clear location</button>')},h="normal",i=function(c,e,f,g){a.log("RISK_CHECKER.VIEW transitioning content in "+c.attr("id")),"function"!=typeof g?g=function(){}:"function"==typeof f&&(g=f,f=""),f=f||"",c.fadeOut(h,function(){a.INTERFACE.resetFocus(),d("#content").attr("class",f),c.html(e),a.INTERFACE.buttonHeights(),a.INTERFACE.externalLinks(),c.attr("id")===b.region.attr("id")?d(window).scrollTop(0):d(window).scrollTop(b.region.offset().top),c.delay(125).fadeIn(h,g)})},j=function(a,b){if("undefined"!=typeof OpenLayers){b=b||"osmap";var c=d("#"+b);c.css({height:3*c.width()/4});var e=new OpenLayers.Map({div:b,theme:"/css/osmap.css"});e.addLayer(new OpenLayers.Layer.OSM);var f=new OpenLayers.LonLat(a.long,a.lat).transform(new OpenLayers.Projection("EPSG:4326"),e.getProjectionObject()),g=15;e.setCenter(f,g);var h=new OpenLayers.Layer.Markers("Markers");h.addMarker(new OpenLayers.Marker(f)),e.addLayer(h)}};c.showLoading=function(){e||(e=window.setTimeout(function(){d(".loading").fadeIn("fast")},500))},c.hideLoading=function(){d(".loading").fadeOut("fast"),e=window.clearTimeout(e)},c.renderResults=function(){var a="",c="";d.each(b.MODEL.getResult().result,function(a,b){c+=g.results_result(b)}),a+=g.results({text:b.MODEL.getResult().text,list:c}),a+=g.search_again(),i(b.region,a)},c.searchError=function(a){a.hasClass("invalid")||(a.addClass("invalid"),a.after(g.field_error({error:a.data("error")})))},c.clearSearchError=function(a){a.removeClass("invalid"),a.siblings(".error-message").remove()},c.validForm=function(a){a?b.region.find("input[type=submit]").removeClass("disabled"):b.region.find("input[type=submit]").addClass("disabled")},c.renderSearch=function(){c.hideLoading();var e="",h=g.geolocation_find;b.MODEL.getLocation()&&(h=g.geolocation_found),d("html").hasClass("geolocation")&&(e=g.geolocation({button:h})),i(b.region,g.search({title:f,geolocation:e}),"centre",function(){b.MODEL.getLocation()&&c.locationUpdate(),a.POLYFILL.placeholders||b.region.find("input").trigger("blur")})},c.renderPlaces=function(a,b){var c="",e="";b.length?(d.each(b,function(a,b){e+=g.places_result(b)}),c+=g.places({search_text:a,list:e})):c=g.places_none();var f=d("#search-results");i(f,c,"centre",function(){d(window).scrollTop(f.offset().top-100)})},c.renderClinic=function(a){var c=g.clinic(a);c+=g.search_again(),i(b.region,c,function(){a.location&&window.setTimeout(function(){j(a.location)},500)})},c.renderError=function(){var a=g.error();a+=g.search_again(),i(b.region,a)};var k,l;return c.locationFinding=function(){var a=b.region.find(".btn.geolocate");a.html(g.geolocation_thinking()).removeClass("disabled find");var d=a.find(".thinking");k=window.setInterval(function(){var a=d.text().length+1,b="";a>6&&(a=0);for(var c=1;a>=c;c+=1)b+=".";d.text(b)},500),l=window.setTimeout(function(){b.MODEL.location_timeout=!0,c.locationError()},3e4)},c.locationUpdate=function(){k=window.clearInterval(k),l=window.clearTimeout(l),b.MODEL.getLocation()&&!b.MODEL.location_timeout?(b.region.find(".btn.geolocate").html(g.geolocation_found()).removeClass("disabled find").after(g.geolocation_clear()),b.region.find(".location-found").slideUp()):(b.region.find(".btn.geolocate").html(g.geolocation_find()).addClass("find"),b.region.find(".clear-location").remove(),b.region.find(".location-found").slideDown()),c.validForm(b.CONTROLLER.validateForm())},c.locationError=function(){k=window.clearInterval(k),l=window.clearTimeout(l),b.region.find(".btn.geolocate").html(g.geolocation_fail()).addClass("disabled"),b.region.find(".clear-location").remove(),b.region.find(".location-found").slideDown(),c.validForm(b.CONTROLLER.validateForm())},c.init=function(){f=d("#app_title").outerHTML();var a="20em";d("html").hasClass("geolocation")&&(a="30em"),a={"min-height":a},b.region.wrap(d("<div/>").css(a)),d(".loading").css(a),c.renderSearch(),d.ajax({url:"./js/OpenLayers.js?_"+window.ebrc_build_number,dataType:"script",cache:!0})},c}(a,b,b.VIEW||{},c),b}(a,a.CLINIC_FINDER||{},b),a}(window.EMBARRASSING_BODIES||{},window.jQuery),window.EMBARRASSING_BODIES=function(a,b){"use_strict";return a.CLINIC_FINDER=function(a,b,c){return b.CONTROLLER=function(a,b,c,d){var e=function(a){a.preventDefault(),b.region.find(".validate"),c.validateForm(),d(this).hasClass("disabled")||(b.MODEL.getLocation()?b.MODEL.searchLocation():b.MODEL.search(d.trim(b.region.find("#search-term").val())))};c.validateForm=function(){return b.region.find(".validate").each(function(){f(d(this))}),!d("input.invalid").length||b.MODEL.getLocation()};var f=function(a){d.trim(a.val())?b.VIEW.clearSearchError(a):b.VIEW.searchError(a)},g=function(a){f(d(a.target)),b.VIEW.validForm(c.validateForm())},h=function(a){a.preventDefault(),b.VIEW.locationFinding(),b.MODEL.findLocation()},i=function(a){a.preventDefault(),b.MODEL.clearLocation(),b.VIEW.validForm(c.validateForm())},j=function(a){a.preventDefault(),b.MODEL.getPlaceResults(d(this).text(),d(this).data("url"))},k=function(a){a.preventDefault(),window.location.hash="clinic:"+d(this).data("id")},l=function(a){a.preventDefault();var b=window.location.hash;window.location.hash="search","#search"===b&&d(window).trigger("hashchange")},m=function(){a.log("RISK_CHECKER.CONTROLLER hashchange being handled.");var c=window.location.hash;if(""===c||"#search"===c)return b.VIEW.renderSearch(),void 0;"#results"===c&&b.VIEW.renderResults();var d=/^#clinic:(\d+)$/.exec(c);if(null!==d){var e=parseInt(d[1],10);return b.MODEL.getClinic(e),void 0}};return c.init=function(c){c=c||"clinic_finder",b.region=d("#"+c),b.region.length&&(a.log("CLINIC_FINDER.CONTROLLER initialising."),window.location.hash&&(window.location.hash=""),d(window).on("hashchange",m),b.region.on("click",".search",e),b.region.on("submit","form",e),b.region.on("click",".place-result",j),b.region.on("click",".results-result",k),b.region.on("click",".restart",l),b.region.on("keyup",".validate",g),b.region.on("click",".geolocate.find",h),b.region.on("click",".clear-location",i),b.VIEW.init())},c}(a,b,b.CONTROLLER||{},c),b}(a,a.CLINIC_FINDER||{},b),a}(window.EMBARRASSING_BODIES||{},window.jQuery);